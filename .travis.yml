--- 
sudo: false
dist: xenial

addons:
  apt:
    packages:
      - "python3"
      - "python3-pip"
      - "python3-setuptools"

before_script: 
  - "pip install --user awscli"
  - "mkdir ~/.aws && echo '[default]\n' > ~/.aws/config && echo 'output=json' >> ~/.aws/config"
  - "pip3 install envault"
  - "envault --version"
  - "curl -sf https://up.apex.sh/install | sudo sh"
  - | 
      # branch to stage mapping          
      if [ $TRAVIS_BRANCH == "dev" ] || [ $TRAVIS_BRANCH == "ci-config" ]
      then
        STAGE=dev
      elif [ $CI_COMMIT_REF_SLUG == "master" ]
      then
        STAGE=production
      else
        echo "Undefine stage"
      fi

env: 
  global: 
    - "PATH=$HOME/.local/bin:$PATH"
    
jobs: 
  include: 
    - 
      language: node_js
      name: "Deploy APP"
      node_js: "8.10"
      script: |
                echo "Deploying the web app"
                cd web-app
                yarn && yarn build
                aws s3 sync ./dist  s3://$STAGE.sports.lftechnology.com/

      stage: Deploy
    - 
      name: "Deploy ADMIN_APP"
      script: |
                echo "Deploying the admin app"
                cd admin-app
                yarn && yarn build
                aws s3 sync ./dist  s3://$STAGE.admin.sports.lftechnology.com/

    - 
      name: "Deploy API"
      script: |
          echo "Deploying the api"
          cd api
          envault list -secret=sports/api/${TRAVIS_BRANCH} > .env
          up deploy $STAGE
